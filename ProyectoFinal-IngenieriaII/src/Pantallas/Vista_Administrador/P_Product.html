<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mugumis Store</title>
    <link rel="icon" href="../Assets/Mugumis.ico" type="image/x-icon">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/src/Estilos/stylesIndex.css">
    <link rel="stylesheet" href="/src/Estilos/styleProducto.css">

</head>
<body>
    <!-- Barra de navegación -->
    <nav>
        <div class="logo">
            <img src="/src/Assets/logoMugumis.png" alt="Logo">
        </div>
        <ul>
            <li><a href="catalogo.php">Inicio</a></li>
            <li><a href="p_Product.html">Catálogo</a></li>
            <li><a href="#contacto">Contacto</a></li>
        </ul>
        
    </nav>

    <!-- para Agregar Amigurumis -->
    <div class="dropzone-container">
        <form class="dropzone-box" id="dropzone-box" method="post">
            <div class="dropzone-box-area">
                <h2>Añadir Nuevo producto</h2>
                <div class="dropzone-area" id="dropzone-area">
                    <div class="file-upload-icon">
                        <!-- svg icon -->
                    </div>
                    <p>Imagen del producto</p>
                    <p>+</p>
                    <button type="button" id="open-gallery"></button>
                    <!-- En lugar de input file -->  
                </div>
                <input type="hidden" id="image-url" name="image-url">
                <input type="hidden" id="Id" name="Id">
                <br>
                <p>Nombre del Amigurumi:</p>
                <input type="text" id="Name" name="Name">
                <br>
                <p>Coste:</p>
                <input type="text" id="Priece" name="Priece" placeholder="0.00">
                <br>
                <p>Descripción:</p>
                <textarea id="Descripcion" name="Descripcion"></textarea>
                <br>
                <p>Cantidad:</p>
                <input type="text" id="Cantidad" name="Cantidad" placeholder="0">
                <div class="dropzone-actions">
                    <button type="button" id="Reset">Cancelar</button>
                    <button id="submit-button" type="button">Guardar</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Pie de página -->
    <footer id="contacto" class="footer">
        <div class="footer-container">
            <div class="footer-column">
                <h3>Sobre Nosotros</h3>
                <p>La empresa opera como un negocio independiente, ofreciendo productos de calidad artesanal 
                    tanto a través de pedidos personalizados como de diseños básicos que son expuestos y vendidos.</p>
            </div>
            <div class="footer-column">
                <h3>Navegación</h3>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="#catalogo">Catálogo</a></li>
                    <li><a href="#contacto">Contacto</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Contacto</h3>
                <p>Email: mugumis.store@gmail.com</p>
                <p>Teléfono: +507 253-0000</p>
                <p>Celular: +507 6559-0000</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 Desarrollo de Software. Todos los derechos reservados.</p>
            <p><i>Lohanys</i>, <i>Johny</i>, <i>Raúl</i>, <i>Josué</i>, <i>Chirag</i></p>
        </div>
    </footer>

    <!-- ?v=N.n al final de un script ayuda a que el navegador actualize cambios realizados subir la cifra por cada cambio importante(1.1 - 1.2... 1.9 - 2.0...N.n) -->
    <script>
        function setupGalleryButton() {
            const galleryButton = document.getElementById('open-gallery');
            if (galleryButton) {
                galleryButton.addEventListener('click', function() {
                    const galleryWindow = window.open('https://raularica.github.io/Index.html', 'Galería', 'width=800,height=600');
                    
                    window.addEventListener('message', function(event) {
                        console.log(`Message received from: ${event.origin}`); // Depuración
                        console.log(`Message data: ${event.data}`); // Depuración
                        const selectedImageUrl = event.data;
                        document.getElementById('dropzone-area').innerHTML = `<img src="${selectedImageUrl}" alt="Preview">`;
                        document.getElementById('image-url').value = selectedImageUrl;
                    }, { once: true });
                });
            }
        }
        document.getElementById('submit-button').addEventListener('click', function() {
            const userConfirmed = confirm("¿Estás seguro de que deseas guardar los cambios?");
            if (userConfirmed) {
                $.ajax({
                    type: "POST",
                    url: "/src/Server/Producto.php",
                    data: $("#dropzone-box").serialize(),
                    dataType: 'json', // Cambiado a 'json' para manejar la respuesta JSON
                    success: function(response) {
                        if (response.success) {
                            alert("Cambios guardados correctamente.");
                            window.location.href = 'catalogo.php';
                        } else {
                            console.log("Respuesta inesperada del servidor:", response); //Consola
                            alert("Ocurrió un problema.");
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error("Error en la solicitud AJAX:", textStatus, errorThrown); //consola
                        alert("Error al conectar con el servidor. Intente de nuevo más tarde.");
                    }
                });
            } else {
                // Si el usuario no confirma, no hacer nada
            } 
        });


        document.getElementById('Reset').addEventListener('click', function() {
            localStorage.removeItem('editAmigurumi');
            location.reload();
        });

        // Inicializar el botón de la galería al cargar la página
        setupGalleryButton();

      // Recuperar datos del localStorage y completar el formulario
      const editAmigurumi = JSON.parse(localStorage.getItem('editAmigurumi'));
        if (editAmigurumi) {
            document.getElementById('image-url').value = editAmigurumi.imagenSrc;
            document.getElementById('Id').value = editAmigurumi.idAmigurumis;
            document.getElementById('Name').value = editAmigurumi.nombre;
            document.getElementById('Priece').value = editAmigurumi.precio;
            document.getElementById('Descripcion').value = editAmigurumi.descripcion;
            document.getElementById('Cantidad').value = editAmigurumi.cantidadDisponible;

            const dropzoneArea = document.getElementById('dropzone-area');
            dropzoneArea.innerHTML = `<img src="${editAmigurumi.imagenSrc}" alt="Preview">`;
        }
        
    </script>
</body>
</html>